_format_version: "2.1"
_transform: true

# Global plugins (applied to all services)
plugins:
  - name: request-transformer
    config:
      add:
        headers:
          - "X-Forwarded-Proto:https"
  - name: cors
    config:
      origins:
        - "https://dive25.local"
        - "https://*.dive25.local"
        - "https://dive25.com"
        - "https://*.dive25.com"
      methods:
        - GET
        - POST
        - PUT
        - DELETE
        - OPTIONS
      headers:
        - Accept
        - Accept-Version
        - Content-Length
        - Content-MD5
        - Content-Type
        - Date
        - X-Auth-Token
        - Authorization
      credentials: true
      max_age: 3600
      preflight_continue: false
  - name: rate-limiting
    config:
      minute: 60
      hour: 1000
      policy: local
      hide_client_headers: false
  - name: response-transformer
    config:
      add:
        headers:
          - "Strict-Transport-Security:max-age=31536000; includeSubDomains"
          - "X-Content-Type-Options:nosniff"
          - "X-XSS-Protection:1; mode=block"
          - "X-Frame-Options:SAMEORIGIN"
          - "Content-Security-Policy:default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; connect-src 'self' https://*.dive25.local https://*.dive25.com; frame-ancestors 'self'"

services:
  # Frontend Service
  - name: frontend-service
    url: http://dive25-frontend:3000
    routes:
      - name: frontend-route
        hosts:
          - dive25.local
          - frontend.dive25.local
          - dive25.com 
          - www.dive25.com
        paths:
          - /
        strip_path: false
        preserve_host: true
        protocols:
          - http
          - https
    plugins:
      - name: redirect
        config:
          status_code: 301
          location: https://%(host)s%(request_uri)s
          preserve_query_string: true
        protocols:
          - http
  
  # API Service
  - name: api-service
    url: http://dive25-api:3000
    routes:
      - name: api-route
        hosts:
          - api.dive25.local
          - api.dive25.com
        paths:
          - /
          - /api
          - /api/v1
          - /health
          - /health/live
          - /health/ready
          - /metrics
        strip_path: false
        preserve_host: true
        protocols:
          - http
          - https
    plugins:
      - name: redirect
        config:
          status_code: 301
          location: https://%(host)s%(request_uri)s
          preserve_query_string: true
        protocols:
          - http
      - name: ip-restriction
        config:
          whitelist:
            - 127.0.0.1/32
            - 10.0.0.0/8
            - 172.16.0.0/12
            - 192.168.0.0/16
          message: "Access denied by IP restriction policy"
  
  # Keycloak Service
  - name: keycloak-service
    url: http://dive25-keycloak:8080
    routes:
      - name: keycloak-route
        hosts:
          - keycloak.dive25.local
          - keycloak.dive25.com
        protocols:
          - http
          - https
    plugins:
      - name: redirect
        config:
          status_code: 301
          location: https://%(host)s%(request_uri)s
          preserve_query_string: true
        protocols:
          - http
      - name: ip-restriction
        config:
          whitelist:
            - 127.0.0.1/32
            - 10.0.0.0/8
            - 172.16.0.0/12
            - 192.168.0.0/16
          message: "Access denied by IP restriction policy"
  
  # MongoDB Express Service (only in development)
  - name: mongo-express-service
    url: http://dive25-mongo-express:8081
    routes:
      - name: mongo-express-route
        hosts:
          - mongo-express.dive25.local
        protocols:
          - http
          - https
    plugins:
      - name: redirect
        config:
          status_code: 301
          location: https://%(host)s%(request_uri)s
          preserve_query_string: true
        protocols:
          - http
      - name: ip-restriction
        config:
          whitelist:
            - 127.0.0.1/32
            - 10.0.0.0/8
            - 172.16.0.0/12
            - 192.168.0.0/16
          message: "Access denied by IP restriction policy"
  
  # Grafana Service
  - name: grafana-service
    url: http://dive25-grafana:3000
    routes:
      - name: grafana-route
        hosts:
          - grafana.dive25.local
          - grafana.dive25.com
        protocols:
          - http
          - https
    plugins:
      - name: redirect
        config:
          status_code: 301
          location: https://%(host)s%(request_uri)s
          preserve_query_string: true
        protocols:
          - http
      - name: ip-restriction
        config:
          whitelist:
            - 127.0.0.1/32
            - 10.0.0.0/8
            - 172.16.0.0/12
            - 192.168.0.0/16
          message: "Access denied by IP restriction policy"
  
  # Prometheus Service
  - name: prometheus-service
    url: http://dive25-prometheus:9090
    routes:
      - name: prometheus-route
        hosts:
          - prometheus.dive25.local
          - prometheus.dive25.com
        protocols:
          - http
          - https
    plugins:
      - name: redirect
        config:
          status_code: 301
          location: https://%(host)s%(request_uri)s
          preserve_query_string: true
        protocols:
          - http
      - name: ip-restriction
        config:
          whitelist:
            - 127.0.0.1/32
            - 10.0.0.0/8
            - 172.16.0.0/12
            - 192.168.0.0/16
          message: "Access denied by IP restriction policy"
  
  # OPA Service (only internal access)
  - name: opa-service
    url: http://dive25-opa:8181
    routes:
      - name: opa-route
        hosts:
          - opa.dive25.local
        protocols:
          - http
          - https
    plugins:
      - name: redirect
        config:
          status_code: 301
          location: https://%(host)s%(request_uri)s
          preserve_query_string: true
        protocols:
          - http
      - name: ip-restriction
        config:
          whitelist:
            - 127.0.0.1/32
            - 10.0.0.0/8
            - 172.16.0.0/12
            - 192.168.0.0/16
          message: "Access denied by IP restriction policy"
