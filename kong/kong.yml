_format_version: "3.0"
_transform: true

services:
  # Wildcard Service for *.dive25.local
  - name: wildcard-service
    url: ${INTERNAL_FRONTEND_URL:-http://frontend:3000}
    routes:
      - name: wildcard-route
        hosts:
          - "*.${BASE_DOMAIN:-dive25.local}"
        protocols:
          - http
          - https
        priority: 5  # Lower priority so specific routes take precedence

  # Frontend Service
  - name: frontend-service
    url: ${INTERNAL_FRONTEND_URL:-http://frontend:3000}
    routes:
      - name: frontend-route
        hosts:
          - ${BASE_DOMAIN:-dive25.local}
          - frontend.${BASE_DOMAIN:-dive25.local}
        protocols:
          - http
          - https
        priority: 10  # Higher priority than wildcard
    plugins:
      - name: oidc-auth
        config:
          client_id: ${KEYCLOAK_CLIENT_ID_FRONTEND:-dive25-frontend}
          client_secret: ${KEYCLOAK_CLIENT_SECRET:-change-me-in-production}
          discovery: ${PUBLIC_KEYCLOAK_URL:-https://keycloak.dive25.local}/auth/realms/${KEYCLOAK_REALM:-dive25}/.well-known/openid-configuration
          introspection_endpoint: ${PUBLIC_KEYCLOAK_URL:-https://keycloak.dive25.local}/auth/realms/${KEYCLOAK_REALM:-dive25}/protocol/openid-connect/token/introspect
          bearer_only: false
          realm: ${KEYCLOAK_REALM:-dive25}
          redirect_uri_path: /callback
          logout_path: /logout
          redirect_after_logout_uri: /
          ssl_verify: false
          session_secret: ${SESSION_SECRET:-change_me_in_production}
  
  # API Service
  - name: api-service
    url: ${INTERNAL_API_URL:-http://api:3000}
    routes:
      - name: api-route
        hosts:
          - api.${BASE_DOMAIN:-dive25.local}
        protocols:
          - http
          - https
    plugins:
      - name: oidc-auth
        config:
          client_id: ${KEYCLOAK_CLIENT_ID_API:-dive25-api}
          client_secret: ${KEYCLOAK_CLIENT_SECRET:-change-me-in-production}
          discovery: ${PUBLIC_KEYCLOAK_URL:-https://keycloak.dive25.local}/auth/realms/${KEYCLOAK_REALM:-dive25}/.well-known/openid-configuration
          introspection_endpoint: ${PUBLIC_KEYCLOAK_URL:-https://keycloak.dive25.local}/auth/realms/${KEYCLOAK_REALM:-dive25}/protocol/openid-connect/token/introspect
          bearer_only: true
          realm: ${KEYCLOAK_REALM:-dive25}
          ssl_verify: false
  
  # Keycloak Service (with plugins)
  - name: keycloak-service
    url: ${INTERNAL_KEYCLOAK_URL:-http://keycloak:8080}
    routes:
      - name: keycloak-route
        hosts:
          - keycloak.${BASE_DOMAIN:-dive25.local}
          - keycloak.${PROD_BASE_DOMAIN:-dive25.com}
        paths:
          - /auth
        protocols:
          - http
          - https
        strip_path: false
      - name: keycloak-resources-route
        hosts:
          - keycloak.${BASE_DOMAIN:-dive25.local}
          - keycloak.${PROD_BASE_DOMAIN:-dive25.com}
        paths:
          - /resources
          - /auth/resources
        protocols:
          - http
          - https
    plugins:
      - name: response-transformer
        config:
          remove:
            headers:
              - Content-Security-Policy
              - X-Frame-Options
      - name: redirect
        config:
          status_code: 301
          location: https://%(host)s%(request_uri)s
          keep_incoming_path: true
        protocols:
          - http
      - name: ip-restriction
        config:
          allow:
            - 127.0.0.1/32
            - 10.0.0.0/8
            - 172.16.0.0/12
            - 192.168.0.0/16
          message: "Access denied by IP restriction policy"
  
  # MongoDB Express Service
  - name: mongo-express-service
    url: http://mongo-express:8081
    routes:
      - name: mongo-express-route
        hosts:
          - mongo-express.${BASE_DOMAIN:-dive25.local}
        protocols:
          - http
          - https
  
  # Grafana Service
  - name: grafana-service
    url: http://grafana:3000
    routes:
      - name: grafana-route
        hosts:
          - grafana.${BASE_DOMAIN:-dive25.local}
        protocols:
          - http
          - https
  
  # Prometheus Service
  - name: prometheus-service
    url: http://prometheus:9090
    routes:
      - name: prometheus-route
        hosts:
          - prometheus.${BASE_DOMAIN:-dive25.local}
        protocols:
          - http
          - https
  
  # phpLDAPadmin Service
  - name: phpldapadmin-service
    url: http://phpldapadmin:80
    routes:
      - name: phpldapadmin-route
        hosts:
          - phpldapadmin.${BASE_DOMAIN:-dive25.local}
        protocols:
          - http
          - https
  
  # Kong Admin Service (exposed via subdomain)
  - name: kong-admin-service
    url: http://kong:8001
    routes:
      - name: kong-admin-route
        hosts:
          - kong.${BASE_DOMAIN:-dive25.local}
        protocols:
          - http
          - https
  
  # Konga Service
  - name: konga-service
    url: http://konga:1337
    routes:
      - name: konga-route
        hosts:
          - konga.${BASE_DOMAIN:-dive25.local}
        protocols:
          - http
          - https

# Redirects from HTTP to HTTPS and other global plugins
plugins:
  - name: redirect
    config:
      status_code: 301
      https_port: 8443
    enabled: true
    protocols:
      - http
  # Global CSP policy that applies to all services
  - name: response-transformer
    config:
      remove:
        headers:
          - Content-Security-Policy
          - X-Frame-Options
      add:
        headers:
          Content-Security-Policy: "default-src 'self'; script-src 'self' 'unsafe-eval' 'unsafe-inline'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; img-src 'self' data: blob:; font-src 'self' https://fonts.gstatic.com; connect-src 'self' https://keycloak.${BASE_DOMAIN:-dive25.local} https://*.${BASE_DOMAIN:-dive25.local} http://localhost:* http://*.dive25-network; frame-src 'self' https://keycloak.${BASE_DOMAIN:-dive25.local} https://*.${BASE_DOMAIN:-dive25.local} http://localhost:* http://*.dive25-network; object-src 'none'; base-uri 'self'; form-action 'self' https://keycloak.${BASE_DOMAIN:-dive25.local} https://*.${BASE_DOMAIN:-dive25.local} http://localhost:*; frame-ancestors 'self' https://${BASE_DOMAIN:-dive25.local} https://frontend.${BASE_DOMAIN:-dive25.local} https://*.${BASE_DOMAIN:-dive25.local} http://localhost:* http://*.dive25-network; block-all-mixed-content;"
    enabled: true
