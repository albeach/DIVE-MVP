# kong/kong.yml - Declarative configuration for Kong
_format_version: "2.1"
_transform: true

services:
  - name: dive25-api
    url: ${API_URL:-http://dive25-api:3000}
    routes:
      - name: dive25-api-route
        paths:
          - /api
        strip_path: false
        preserve_host: true
    plugins:
      - name: cors
        config:
          origins:
            - "*"
          methods:
            - GET
            - POST
            - PUT
            - DELETE
            - OPTIONS
            - HEAD
            - PATCH
          headers:
            - Accept
            - Accept-Version
            - Content-Length
            - Content-MD5
            - Content-Type
            - Date
            - X-Auth-Token
            - Authorization
          exposed_headers:
            - X-Auth-Token
          max_age: 3600
          credentials: true
      - name: rate-limiting
        config:
          minute: 100
          hour: 1000
          policy: local
      - name: jwt
        config:
          claims_to_verify:
            - exp
          key_claim_name: kid
          secret_is_base64: false
          run_on_preflight: true
      - name: request-transformer
        config:
          add:
            headers:
              - X-Forwarded-Proto:https
      - name: http-log
        config:
          http_endpoint: http://dive25-api:3000/api/v1/audit/log
          method: POST
          timeout: 10000
          keepalive: 60000
          retry_count: 5
          queue_size: 100
          flush_timeout: 2

  - name: dive25-frontend
    url: ${FRONTEND_URL:-http://dive25-frontend:3000}
    routes:
      - name: dive25-frontend-route
        paths:
          - /
        strip_path: false
        preserve_host: true
    plugins:
      - name: cors
        config:
          origins:
            - http://localhost:3000
            - https://dive25.local
            - https://dive25.com
          methods:
            - GET
            - POST
            - PUT
            - DELETE
            - OPTIONS
          headers:
            - Accept
            - Accept-Version
            - Content-Length
            - Content-MD5
            - Content-Type
            - Date
            - X-Auth-Token
            - Authorization
          exposed_headers:
            - X-Auth-Token
          credentials: true
          max_age: 3600

  - name: keycloak-service
    url: http://keycloak:8080
    routes:
      - name: keycloak-route
        paths:
          - /auth
        strip_path: false

consumers:
  - username: dive25-frontend
    jwt_secrets:
      - algorithm: RS256
        key: "dive25-frontend"
  - username: dive25-api
    jwt_secrets:
      - algorithm: RS256
        key: "dive25-api"